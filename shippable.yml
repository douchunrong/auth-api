language: ruby

rvm:
  - 2.3.0

env:
  global:
    - AUTH_API_REPO=partixyz/users-api
    - secure: YmsNkuJFgphmxaXoXnlVdpYdQREu1WnPbNfDNegaWiEsRZw4C7LYrwXwy0zYLr+Py9lg4W5TM4MCo6zSebN1oJr9yuR8ID0dD1g+oMj6HbFgnjgaySLjjWxubWDZOX5+dRJ7MigSqtSZ+T9GvvXsPePE1gEuxZa3Rxy3/KCh/8ZnDCle11tLgSreko+1znjbTCwOtX09ER0OAtA5u51mQv3KWQLPZC5uok8TVgWZ7KU0gDe1v9amRQzEnbICMr8yBwyuV4kcPLaS3QuomzW+e7K2en3fRRPscAoh+lwh7HqD3TQ/BJ+iOTgjPjgJlSeh/+ScKyhgfqKVxSooSn7ecQ==
    - secure: N7coz/N9DmaRmIlvqzZS5N0YG4GPChJ2DRZWJnE5cPuqLG1JmTV7zo4BvTMUScYV1+1V+AaJbk58MEMDyiKWPmGkNLMTh5zOBVg5UuXv1XCnTUKrKhCSD+C0g7j/6L1MJwK2qS7CGkjzVZFM/PpGMYFKloCgD69JeYzUdPD/kdyuEOfTZ9T0xizEeeqfP8RYrGSwRgcbnAxqyP8kTuqtyVBdLv5WKapWuNrelCWfF+PKDHfRlAst1gnSgapZuIdQ5JG/iRJiNMIuR7pkueRNtEW95v0mRJXNkshFByRdy2s2DsBRrrB08raZ2yX36gP6v/anALmCF3WKNfdMdRbP9A==

before_install:
  - sudo apt-get -y update
  - sudo apt-get -y install libpq-dev
  - apt-get -y install python-dev
  - sudo pip install -U docker-compose
  - export APP_VERSION=$( git describe  --tags --long || echo ${COMMIT::12} )

before_script:
  - docker-compose -f deploy/docker-compose-test.yml up -d db
  - DB_CONTAINER=$( docker-compose -f deploy/docker-compose-test.yml ps -q db )
  - export DB_HOST=$( docker inspect --format '{{ .NetworkSettings.IPAddress }}' $DB_CONTAINER )
  - docker-compose -f deploy/docker-compose-test.yml run --rm users-api bin/rails db:setup
  - RAILS_ENV=test bin/rails db:setup
  - docker-compose -f deploy/docker-compose-test.yml up -d users-api
  - USERS_API_CONTAINER=$( docker-compose -f deploy/docker-compose-test.yml ps -q users-api )
  - export USERS_API_HOST=$( docker inspect --format '{{ .NetworkSettings.IPAddress }}' $USERS_API_CONTAINER )

script:
  - RALIS_ENV=test bin/rails spec

after_success:
  - docker build -t $AUTH_API_REPO:$APP_VERSION .
  - docker push $AUTH_API_REPO:$APP_VERSION

integrations:
  hub:
    - integrationName: partixyz
      type: docker
