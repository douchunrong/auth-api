language: ruby

rvm:
  - 2.3.0

env:
  global:
    - AUTH_API_REPO=partixyz/auth-api
    - secure: YmsNkuJFgphmxaXoXnlVdpYdQREu1WnPbNfDNegaWiEsRZw4C7LYrwXwy0zYLr+Py9lg4W5TM4MCo6zSebN1oJr9yuR8ID0dD1g+oMj6HbFgnjgaySLjjWxubWDZOX5+dRJ7MigSqtSZ+T9GvvXsPePE1gEuxZa3Rxy3/KCh/8ZnDCle11tLgSreko+1znjbTCwOtX09ER0OAtA5u51mQv3KWQLPZC5uok8TVgWZ7KU0gDe1v9amRQzEnbICMr8yBwyuV4kcPLaS3QuomzW+e7K2en3fRRPscAoh+lwh7HqD3TQ/BJ+iOTgjPjgJlSeh/+ScKyhgfqKVxSooSn7ecQ==
    - secure: N7coz/N9DmaRmIlvqzZS5N0YG4GPChJ2DRZWJnE5cPuqLG1JmTV7zo4BvTMUScYV1+1V+AaJbk58MEMDyiKWPmGkNLMTh5zOBVg5UuXv1XCnTUKrKhCSD+C0g7j/6L1MJwK2qS7CGkjzVZFM/PpGMYFKloCgD69JeYzUdPD/kdyuEOfTZ9T0xizEeeqfP8RYrGSwRgcbnAxqyP8kTuqtyVBdLv5WKapWuNrelCWfF+PKDHfRlAst1gnSgapZuIdQ5JG/iRJiNMIuR7pkueRNtEW95v0mRJXNkshFByRdy2s2DsBRrrB08raZ2yX36gP6v/anALmCF3WKNfdMdRbP9A==
    - secure: ZBh8AmfsybsC33ytwRmfmoM0Ns6gJJE/dkWuXV6owqS+DE2RXxeHIdOWU06hlCXOHr2ZID9zfSYJqnWqxuJkJOpcCy8GEt7QtoQWUJCEVrADeWcyeyaBpWHRTswgOrXZTs2QGUjap3WC1W4Vggl8xSRIfOfNw0FKDfFLxbK9lRLs+V++3QKGIHcSqoce8BEp/1lIv0xHXx+WhCt6OVdMmQhRFhEZX6N4HWQWh2N9o/gBApRfsV4T6XdaAlqmZv6OAxqOd/vPbbaWEPGMmd9cz7Cx9MiJbTYj8XOi8cPRTOhCIQtEfYlDzATTs9NwFTdJHe3TvYjDG3mA957e981Fnw==
    - secure: BrxKMULhEB5hVTVAlUiRI5eDl9wyGLzhOGgcIvf6A0Z9WkayWIP9539fdttlmNFsv9hldTQAvzBmq3frvqCFuTLR6nF2F29scC4IZxUdM/fXmgRfqY4JRUVRv0Y4F2KyanWqBOS6JIRB5oweFHUbGJAW3ktdc2nkEVcq03GaLacZiaGu+o7mA/8ey4OOEd7vC2paTfLH7Ws+ZCW0YlevZGuY7XPyff4KB7auBgPAQFrC4uLoYmc5NXWXIephJQhwKcz/jG9kX1AllJHWvj2DAY9g2BA0jfG+32NnGbRM8mMtGj011NXjQYD5+8MfKLrpebrlZFPv4fnpm8HOYC4I7ig2S3ZWnr8iG0375W11WZBNEanJBraXl8t7DlMgdOHS8gqtNUgiYvRXo8RHgD2+0RPvL8v40EYFMFT8HLkiol4590MH3AQSNs6qVEozs+pm5l7irTauhIsPIfJLyf8vw4pl3mbogJlCbUbDIkV4Ko77ux+DFZLoSn1qOBbeIAdlt3XYbVrycwGXwvoD1tYbXNi5zB4tLfxwkgGixhKB+AFjnYEq0cS1ki6S5twbEc0IlkaxjnU5s4yNnZ3C3dMuTceYBKZS5L972j7G/fbrygFKb3LHiMwQiWWFhzV9JfxAqOmpN1hOyA9pS9kcPNmHp4+NnePEKgYuHwQ/GGymztbJln1lcldm10z91gt5i/kk3s8KUVFq4UV6DcJhOh8gkxeFtBuiKg/VlDUudT6oWEWgFBrva3OPi3eeXwlRO8zKPaev7W/Vm6UGCgg9cMr2zQS41ErjWYXpGxWnMu1K30LIp6TNpY//j2EQmMVlWJuYg7d7xfP63c7WzIBdMbwXRQpjTK2XYtRN/7ykwRpgBsd7DOa+DalgNI1NBaEHiaHM5oROeRci5wqXqPy6/0YXMOwpFqxAGvoFMOms5EcaRzufTywZRxc3IQD9o3HCwHC0k7sTKB9jSyvQA5ZlHDVhBzGiwQwpT3kcHER42IhCrFgz0T/wO5b3rYmgNxL4qwr2HRm0wcbEZioj/MKtfS04GpNqIQsjNcCSiRZgNuSXuLb0W1WN2r/jAfW/W9Wv8gY2fa35Olq5kGMMzPxUj/nOW2GmKuxmlm2ciTkEJnaqbywQ2luGlGq1REVua+JRrJjTR8mPTGOzbEgDfi8m23L8gFlnGUc0lPqASzz2olVJev6maIE2BIQExNCnRvE6DPQccmrVPcxmjqNUHp+5dbGl3ncZObITNO6gTwECE99IaiNGINh5ogC4rnhD1H0WOb02WJ27xmQagFt6QKWTDqbzf1pV4TQ1/PxUK9HLtY6dJF3Yt3ZBa/8skGsu9NYRF8u2ukE6jwNCrcU+p9c4Oor3bkqGeN2iUgW58uHiFNqcnlt/XYFEuNdaCf/1FAhb9AGiOk9hAfeOGzgnoOdpxi6YDbBBVrVD4nelDf7lGb0ToicM+BsJ4i3vkUUKRbGVtWpplhpF2xW9fEXLQZ4UmiWshaaSIXB1iglEHqDEzq+iH3S2FKxRc0Uk6qrUIMhv4EDPY8hHhKZCiMkJWaIWCMKTtKVQVQpLdRuctghWNB86sPImMEASMTaioKjtGXm4s/7RL4BvdIgLonOLmELlayV8YNZsLApv/EBLZHsd4QBbNDuHq4rq5M5slHaMAoMpUcy0SH0hIMT/UzvQBNbW8ifkUn0/61ATchLXGRPjeZPPRUzC3eYF5/+ONvoAwBwHI/acIL2O/8LejivXk/wH04r8vK11h6KdXDRym3C8tDgJUIXSRyO42/1Nz7sjJxfXRbRsJzFlMhaKDE/b7kvLeIJ52lzqIkIHv/KjFlhvPb4aWq4O5lb/mS4v1vdOCgpiO7UXLVyp55h8KqLwDzcrp1nBFdNMTlJ/BevE9AnuezKUJzUL3uCxkU4o+Ailmd195crGsTOvo7xeg+6iIzqSQP4T+uRKFs/LlV4O3BV1gI8+Z8z0yRO5J+iljYSsd8G/QymUUQU9uoWuV66+ykGD4JVgr2dLE76Q+vs2YLLhVyIEQ09jRm627U5e4xhSFwqnDJceJ4ArGZGKslDfNfPmiuwVJCN132hMQOhw8j5KFNpmrok7fy65tN2MHYlv2kDlIN/eIKRPfVGa5E7O+RhEUZa9eNfIWvHIw815hbvdR4S/7ISXGFsujqZTJhfqa8Jl1k0xbQMpf7kISmbdTVrc/HtkEjwRfpUptSkzb8fYR4RX98v9KwTbRFpSk8M/ZuKjn9Ar7JWupXxycXPa+kLC6XLZmt9qKps6SEvaXIbLzbvZtAcqkOnYXcm1a0TXRXs6xkHQT7aVllE3STe90M5Bdz+bzzyhFSG9wYYtoa8hlYKn+Zf44RBzYHKXkSHF+1hKLFoSJGlAwlkFxvj73E4vJnmEWnXZu3YKdZTAR0GjKcKAghqAzbw1IaXFCHNDal3Ml0CsCkQr1wFcNKR+P65EHIgfzGxl8eMQQn5JgQrnzzPMf2RHpk79PdoyjWSmH1tGWtgOlRhTI0DPIfPk+QhFoVYEHTAsKWR/Le1Z2cpXnDSHbqthuRGdg/XBdq3sv2HpiUCBcRO5/FKvtIx+qSg0ex/e4dNuW/AMoiLN8A8QkEjUsHETKxly/kDYayzhLIo1s96EHA3iBv9pGvwmDwF5GzI+ZbWGewscrxPsB5wQn1tuu6eMNQmxYPielhSJCcEO5cark40TYnz1PhznExqJt7Vtjvasqmy8aUyNYkfVyOPTKjfFnU6UfCTw4h8vnFyqUTrkI/D93uN38jNwXe5OZxR0//0o8PaNL91wJznifm5tgfhElwk7MUDoQCD8ERLFLnvmpMtDSwh3gVQWZT72czce85KuhJy7BOXkmFUKku4FpRadkff45b/Hhk9TfBtm1QrIsAdvAFSS3j/TNc0u+p07jaWMT3qadB3JznKxxcwux76qrI+PjhN+fS71UIWeZbdKqdLHrG8bxSaF6UYyN/8rcWDIR2Ov5Eg7HLymqsG8LhvW8MTM8oRMl60OExCgQK+oDE/en+7cSfzgeZHar3pqMlo2a7hJhn0SysV6PwW3/W/nVlLurpbjW4ySJWUPN3lMIKNYJ//CtTWBo/LgU2flH7EtZ4grK+Zs9swH6lndp+YGSqbh9pCEnQAtXVlRUkhdW30HjKjaVRcSiWawcZj211l6Y/jEekTEVc9OmbvyPIKxTWeNpBrR1ZBvjwDbk0Oad1nkDE6KDUtKCAmnsmfSiBPPShdi4oEhtuv4FRPv/XxacPysINSH6RyrlmSzmsLt+nTuLmXo8JVtV+nDcYde5MfzBaOSm+W/bAhrvVUrAZzXoiS2IYbCkG7bAIna4NCTJkPMRjcDJTXnGkbusYTU8ZVtKPwmRSZsFirjZ84pEHPEAtjczNcxUjiXT8u8Blhf9DvjuV60J7GcWTF+uDqSGaY4cCoc+wTck4ywiv2WXpiaNzDsobmFecghi3zAEMU1TjifGnxlYgBPVizs/F0ef7Hkyjc870i7TdIUWfZKMdnYvM54F1LrCTQOuHUNz/c+QxJqOrGF98KVGCxtqhTmK8kn1JkR1khTIrroNLKEwFnIE94J41/3p55Lac0ZTJfBjXeCbh5RHrYbwfm2n23RsSoTYmzgdUrLISoaHH0MXfxbKgNZNLHMCGJYoczhoWe7V3AhqirVccQfqbuG3YkbUlDYPGGMzX6unZrYPZFUk59lCvMPlDKvAA5I69J6QT6o4Wlv2JgXLTAD8aht+y2wCqzFwFXQBhzXruUkUhVoMY+0rpfPckgL2+A7Yo7Jdt3cUL/tJ/SGhZLZJdu2maUAMJlnCjBrKdYMyyIb705mMbSd7cXId3whxrzmghzfUQk+EAUIpH+oFZ+KG9akyf1IdurZGtfsg5NIe+qO5l0kJ8f2TkX3coSFH2+fZ4+WVosXx94wKWU2ZVHBwcclC0Qj/MV64VHioDZNUEqpwnu3JTBDhTjAgG3RY6QnDus7s0k1EEuTGcDE1F1ibzDDXcBTCfvcIPANDDVKP02gRzChdbi0KCuDgsP2It+OvRnZIq4FUs5Dth9e7FFmF9gr/syfY9KiYaZKgpw4awenHD0Z2o5q59yLdzj/+NBOYovAwIsv
    - secure: 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

before_install:
  - sudo apt-get -y update
  - sudo apt-get -y install libpq-dev
  - apt-get -y install python-dev
  - sudo pip install -U docker-compose
  - export APP_VERSION=$( git describe  --tags --long || echo ${COMMIT::12} )

before_script:
  - docker-compose -f deploy/docker-compose-test.yml up -d db
  - DB_CONTAINER=$( docker-compose -f deploy/docker-compose-test.yml ps -q db )
  - export DB_HOST=$( docker inspect --format '{{ .NetworkSettings.IPAddress }}' $DB_CONTAINER )
  - docker-compose -f deploy/docker-compose-test.yml run --rm users-api bin/rails db:setup
  - RAILS_ENV=test bin/rails db:setup
  - docker-compose -f deploy/docker-compose-test.yml up -d users-api
  - USERS_API_CONTAINER=$( docker-compose -f deploy/docker-compose-test.yml ps -q users-api )
  - export USERS_API_HOST=$( docker inspect --format '{{ .NetworkSettings.IPAddress }}' $USERS_API_CONTAINER )

script:
  - RALIS_ENV=test bin/rails spec

after_success:
  - docker build -t $AUTH_API_REPO:$APP_VERSION .
  - docker push $AUTH_API_REPO:$APP_VERSION

integrations:
  hub:
    - integrationName: partixyz
      type: docker
