language: ruby

rvm:
  - 2.3.0

env:
  global:
    - AUTH_API_REPO=partixyz/auth-api
    - AUTH_API_EXTERNAL_HOST=external.auth-api
    - AUTH_API_EXTERNAL_PORT=3030
    - AUTHORIZATION_ENDPOINT=http://external.auth-ui

    - secure: YmsNkuJFgphmxaXoXnlVdpYdQREu1WnPbNfDNegaWiEsRZw4C7LYrwXwy0zYLr+Py9lg4W5TM4MCo6zSebN1oJr9yuR8ID0dD1g+oMj6HbFgnjgaySLjjWxubWDZOX5+dRJ7MigSqtSZ+T9GvvXsPePE1gEuxZa3Rxy3/KCh/8ZnDCle11tLgSreko+1znjbTCwOtX09ER0OAtA5u51mQv3KWQLPZC5uok8TVgWZ7KU0gDe1v9amRQzEnbICMr8yBwyuV4kcPLaS3QuomzW+e7K2en3fRRPscAoh+lwh7HqD3TQ/BJ+iOTgjPjgJlSeh/+ScKyhgfqKVxSooSn7ecQ==
    - secure: N7coz/N9DmaRmIlvqzZS5N0YG4GPChJ2DRZWJnE5cPuqLG1JmTV7zo4BvTMUScYV1+1V+AaJbk58MEMDyiKWPmGkNLMTh5zOBVg5UuXv1XCnTUKrKhCSD+C0g7j/6L1MJwK2qS7CGkjzVZFM/PpGMYFKloCgD69JeYzUdPD/kdyuEOfTZ9T0xizEeeqfP8RYrGSwRgcbnAxqyP8kTuqtyVBdLv5WKapWuNrelCWfF+PKDHfRlAst1gnSgapZuIdQ5JG/iRJiNMIuR7pkueRNtEW95v0mRJXNkshFByRdy2s2DsBRrrB08raZ2yX36gP6v/anALmCF3WKNfdMdRbP9A==
    - secure: ZBh8AmfsybsC33ytwRmfmoM0Ns6gJJE/dkWuXV6owqS+DE2RXxeHIdOWU06hlCXOHr2ZID9zfSYJqnWqxuJkJOpcCy8GEt7QtoQWUJCEVrADeWcyeyaBpWHRTswgOrXZTs2QGUjap3WC1W4Vggl8xSRIfOfNw0FKDfFLxbK9lRLs+V++3QKGIHcSqoce8BEp/1lIv0xHXx+WhCt6OVdMmQhRFhEZX6N4HWQWh2N9o/gBApRfsV4T6XdaAlqmZv6OAxqOd/vPbbaWEPGMmd9cz7Cx9MiJbTYj8XOi8cPRTOhCIQtEfYlDzATTs9NwFTdJHe3TvYjDG3mA957e981Fnw==

    - secure: Oc+SpUlUvai1yPUTVLsL90D6CEaaM2MQ8bJ/D91IGuXbV+YRqWur6ryJJbMYSEFvYuenFPID6SsiusUMsBE+HYQejfAEDFqL9ilcqZE5Waes4KvDfwMdN4OLEMCM3dd6n/525Tls1Jjy0t6CjwpbUU17mD+cqAewGAA7425RGTthJG6hO5U9KsBsTHYj9HErNB+0gC+l9iQlE4mdOVb+/X0mSY5AIhdLXBMR0WzIrsC2hFLGxCi5VyaQe2wcKVHpTvorHO7PKgjpOATklHC/LqnLe0m5HBmAOf3leKJ/OD8CslkvZkiNLSZu+pjsB/9tyCsmFK8UNXOByT5+E++FSH39T2R+zPnkEm6NgF/T1/hd0WjdQwi1aagMi4n38tDjihlLBp5+/wUnXYfhC5wPEIr48hEUvYTc50+KFc1XkUwvnyz/AOlpcfapLIbXQmvv4z++A8SZGcWaI58xvB00Y7hxVF43fr0KbcAUrFaoUX22wutoC+MQdA2C5MAYGrcOFwr8pEXs8j43gauEn5PZPyuHA2JG1eULzakwl5Lj/t0qKgH0WRzwzxjym66ySMfs0e+n6x0LSDTUTpFjO4IqMWimvkDrRx8Y5TUGNuPpEMLegjJfmUTr+gDiuPW8EpJDVNJj4jsJmTc0RvrkTkdFnMqQ5Pm9vBP0zmpCsSvssPoY5wxji8/zHKoUgOk0dFXLmLN0vZsCXvuvC3Fuj1TQmxYdSwQhZSF0Z1vrCfPydMkdmOt+U4B8mNDhV4QaQ6gDOTgozjdm1yw0Wfzs2mxVrFB2/M7O8BRtVBopthjS+oUpt+k759mjB7frQ7+4y+ZM1SSBtKKgVSZazp9qrQppnFXNSHHEFcqzNdEoXgYpFqIQWyn5RpdgK6qKHtj9Yy30hC2Nb8fTrabCq0oNSrRgeGSYWg1OMsNs+ZNS9HmzRYgOMGhBFTI7ddU4U2HHXo0TGE3Joghkwtt/BkSM7SNwzLpP1Mvj49h682Ly5i2yidYd3TkhkqGpkMHx6uSnVehzfgN7tiC+YNF+6m+z81irQFwIIO5wT+QFHt2pLr4SXDzwAYcvhtWB0f1DmfdEvt2G8sxp7x2guBZv8WvWXkKnwwW0FFdyxVR+fWUlMoJkZO19YfUJGWOSv+Z2OvgqJ3gnW89ULZNd5PkNpnfEVQPFL3sw4iJhWWxnCLHiIG/UnjY/YnSMkOt8sCjGQidFIMh16qFiv0h0NrzpI7BEisj01/0P0pGxaD0SCRUz5ASWOoaSMwJRozeBWpK3UUawZSpCbCmVemDRbmbDU41ag5UAwqpttL6G/1oFbcgeaImX8xUlZXz8XA5NvwHluHIyM83o9Zf406QyfGDPHOC9wdP84dJcvYaRFfOvv40jI6wUR713eoDlGW/DQjENDdvozKTE7pqdGS6p8bAQEMb5rHlYlJYLDAXQ4bf28TElYBZM/3eVGJ9DPErtrcIFc1mdbhYETqc1+20wPqkdmb/CijMS59nOpaSQKCIsjfDISnrMM1ivXLurdsa923v6onH7YbgDbX3K2tJnct2V8JYVETD13QFDQ1Mb4uthXzucy0/x5lU+ytHFnz8DM/R+PPdtLVWI6uBvgr9kYMtjYmzpSakW0G1fyR1eimdSdiYnzSSyLp9XGcTP/WYLPia29umzVEBiolaXK2JIuDpfS1zVV/s6Dz0MzT8bqigA3VFbmXEGzCaH7nZUJk94nKR2+iEJVu0PElCawlDHCa9NTdFwv3rM9HRyDxAavNveESbtCXDN0vKe1HyEskQVn+VaGWCEGIziFEevH0kLN8upHleuM3ddmJjaF91GKH9ZWty2jLwz0E1hbYn05lrVAg3KyK715OY4m7DoeCMFMtOb68MwGxBDLwd8eJK1Rse95ycDivjG9pMfymOEYQuz5g5QfxBRbRG9FQAa+BxZCawqZNTZbwkKy2WgKpD5xRfnqPbiBzGcKzAXSxbD+c8CJynhZQLMcP/h2G074PW7DHTVlj28EBNt1AFpizeUPfAp7ce9VLyUmkmhfEO+n4BrhWYA1xlct0/prTGmzmg4+7lnnq6VTiIAvKxPdeNeMznYar6jd/xneARiylc+iZaqBRh9UIAhNMoC1iddrJiwFPsjAtPtjfSCwMFOmLn9/rJwS/LHLyTXGXhBd6t4VSqOaB6/NkNxwFnSDvb1KzgxsKNeYphwWzngBfxueOFDd+FkVHQmaouqx5J8/CnfLTJTP5EivEOz1C8/ZG+1WNjZthKhomIpjvfCuIawbh8MFPOTADwuk1RRuE0AhQavO/BqI1xmBZ9bKoEt7fL/EsqUW01tytd81ep3/L7amOWTKKrupD9nGQC3Om35ATr0UK2SkkZ/oq+kNlb8pM2Qtgo0tzOJYZCn6WDdVhNv9qY7k+csxGjXAOhNm6lFf3qgWpRhruTNUjvHkyOUEho0vm77Z1VXr1HV6JdOAB9+WtK14aDrFuGbGW0/CLBdfRyI1eR1GvdQzl/7lMVn8Abol4bl+JOm91O4YgqZIFYcn+OZpftfJ1cD1tkfpVvGBW/+s8GnplRP+1mJKk/Bjeef5P9KKZLrX59lJjxucus3lf1JiNOcTv03gJNkAh+wXTEZfO66NQX0mgTszqOtbcF3kNZAeoebxJR+DvE+Qlvumt+jMxw1JxYbIcvMwUjpgvuY5t4pPJ+ZVARqCq3EF/auao/Q5/WqqMQrBtRtjLSj/jBzFRHsZP1gbSiY7+LdVLlniUbZpPXbpQAVNg9xFLoKIkTFaMIspseuucSXrjOUnHC2RdaJgXmXbRZxm8U0NB6JCdvLYOWp0gWLGHXqbBWBZhrlgOU19Z3LkhfCRUDqsQ4D4JU5XR8qSVdRY3NHFAt/8LmMtkcKM1DjRqSzpMcjD2ykY4Xyp+jwFwgBHQk1D4I6hdfEUrdv3QJfQuo+iTVZZJW4BDs9UZc/tyAh6WxTn0sEEwzbe6Kczf+7bjuwvP8woPSgPqQApGjUEiof9cSVtNHI2UM0AOjr5qMJ/dLqletS8XlIFHtLPECHpA0AWpTDw0s4GrUEUaKMsx1oPLBIsK0BqwXly3aOYptS

    - secure: 4WhT8x70MVBYywe4HMm6Xmpr9r24CTNET7Q6byfYYb2V41bPCrPFqV7Hm5LE1mfTJsx/QTs8wUmXb9LsX/4KymtBfqJ1kgPEEEmuPhxpzaG1YvECbH2PGeOBqr+8ZolxwPTj8ot2ETCHBO+GoxS14WJhbSR4wKWm7+9NSF6Y8AoO5MI9P5CefZE7IhX1dCGMuJcmAu9VbrdPUclJNEISfSlnZyxIZcWROKtdMgMRwIeIwjg1SaAxGQkGzZef0D163JsIGBxUAP4ZYpU9bsxaFydYefHDFrQyK80AG42oZr/Vu8hX4VAw+UNp/5+letlRd4NcK9RG80VpqIPxsWnPEkDeIOWrC9oTM3IBidcAyJTvgKfGhG+CazHsqUPOniHbvr9Y6o06kFelnpol43nTYG3P5+VVssU0/oqIV/MbhIqqC7cwyWwKTNoRfm19hqHca46GRHnsjs7yfvzmJdeoL4zrFljbUseu5jhF1xteoRLZOVKWHyNiPinMdTkd0inB1LTO2x6dvpdB4XTDVwQODoNOmJUo5VVshyq2mWZrdZvoJR6YzvEVTX4EGaJEvmg91fRnXRJS5WdwgbGW5H4Bu2vYZBMmKjMaWliuSxGJRVQH5ddhex4YWFWP2VrH0Ts9vC0wD5XhlL1U1bIBtTiR1sl+2cZxt6fqX7jRa6+p7Bsy+Hedr1g/WgpY3lO4TPg6geR7Gn1is5YuhfabMPzGOpZf9dzq3C9q8Cj1Ox8/R64HQPLWS191PG/upTbv9+RBkcwp7bMRHFVrZhGEG4ic/kGtWAkta8RBLj6OUCSUHRr2Vyo1zmuvgAIYMlTWytSFAlqtUZKbiJaOKQpTtnf0zyIPLft/lYjJDodh1MXi+POPYTNvf2d3tyorPS2JPkX7UP1QTwEU4pXhhKjWh3EREh6cnvXAEgEt0Of7+1oVZNPzMJTFZtDoU6i3K9RyKhE/OhG+MuKSotkXTLYxfQvbouMZ+/R4S8Gf/bY2UFhNd3g3NEF+87a7CptGjI+id0vVlyZ3y4vXnFI0WaZeGNKx2buMsWVTQtQyN3njEtqMi78qat1AMLnoz1jsZxPSN9qDRezPEuckossM7RaiWfZAavJJqWffHCFb6nhvTsvYI3Ac/VQJmXdssYHAckzb/fwUzdUlsCrhkWvu5E38nFVc5oPW7opFcw7MqrKvzRvpM+8UFQST618pZdctcpYGoaSj6XGYk3uWPjgTmaBoBBZIzxliwWpYf1FEj7ccvZy9bFUQe3HwBUDCWIz4DtkGfvb66eQLbhl9qKL29KBpNEDrW6K1qscizntCNg1pQyxCUtKLFlXUj/R+h+pPtvoiRvWBrTpHGOICvMmaYdviUEfgO2/gW8vwue/TGMtkzo2dGNlGjPZ3IfuROFQss2+b0Ev+3mDVXe/ZHsSkDkpsZr7UZNobKbbztDsk53/8D/Q8lI52dDvQj+nieuYh2yhLIPEsygpfNGAEOaDN6y8cg14tKbUEmdrI2wn4cHb5LKP0u/JJqSkbUNaFDMBd8ZDYkf5NpVBuQuqVxhiNg+4QN0HOmmnzZLHsc5zomakYo1VpSeyMv9KOqebuHbLHBPrm9SQbFTlPO70nq7wqPKsPGqTCBfHAGczK+JTwKtlbUkRx6Fwx4x65S/NN6c7ma7JiRmtJnlaPCFIbgAK99C0yYneDLfNnIZrweEZ9CyMJFWFR8kE=

    - secure: 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

before_install:
  - sudo apt-get -y update
  - sudo apt-get -y install libpq-dev
  - apt-get -y install python-dev
  - sudo pip install -U docker-compose
  - docker -v
  - docker-compose -v
  - export APP_VERSION=$( git describe  --tags --long || echo ${COMMIT::12} )

before_script:
  - DOCKER_COMPOSE_FILE=deploy/docker-compose-shippable.yml
  - pwd
  - ls
  - docker-compose -f $DOCKER_COMPOSE_FILE run --rm echo-server pwd
  - docker-compose -f $DOCKER_COMPOSE_FILE run --rm echo-server ls
  - docker-compose -f $DOCKER_COMPOSE_FILE up -d echo-server
  - docker ps

  - docker-compose -f $DOCKER_COMPOSE_FILE up -d db
  - docker-compose -f $DOCKER_COMPOSE_FILE run --rm auth-api dockerize -wait tcp://auth-db:5432
  - docker-compose -f $DOCKER_COMPOSE_FILE run --rm auth-api rails db:setup
  - docker-compose -f $DOCKER_COMPOSE_FILE run --rm users-api rails db:setup
  - docker-compose -f $DOCKER_COMPOSE_FILE up -d auth-api users-api
  - docker ps

script:
  - docker-compose -f $DOCKER_COMPOSE_FILE run auth-api rails spec

after_success:
  - ./deploy/build-docker-image.bash
  - docker push $AUTH_API_REPO:$APP_VERSION

integrations:
  hub:
    - integrationName: partixyz
      type: docker
